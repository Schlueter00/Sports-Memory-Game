<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Sports Sync - Robust Version</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/nts.js"></script>
    <style>
        :root { --bg: #0f172a; --card-bg: #1e293b; --accent: #38bdf8; --text: #f8fafc; --match: #10b981; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; margin: 0; padding: 15px; }
        header { background: var(--card-bg); padding: 15px; border-radius: 12px; width: 100%; max-width: 600px; text-align: center; margin-bottom: 15px; border: 1px solid #334155; }
        .controls { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
        input, select { padding: 10px; border-radius: 6px; border: 1px solid var(--accent); background: #000; color: #fff; }
        button { padding: 10px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        #restartBtn { background: #ef4444; color: white; }
        #shareBtn { background: var(--match); color: white; }
        #syncBtn { background: #6366f1; color: white; }
        button:hover { filter: brightness(1.2); transform: scale(1.02); }
        .host-only { display: none; }
        body.is-host .host-only { display: block; }
        .grid { display: grid; gap: 10px; width: 100%; max-width: 600px; margin-top: 15px; }
        .grid.easy { grid-template-columns: repeat(4, 1fr); }
        .grid.medium { grid-template-columns: repeat(4, 1fr); }
        .grid.hard { grid-template-columns: repeat(6, 1fr); }
        .card { aspect-ratio: 1/1; perspective: 1000px; cursor: pointer; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.4s; transform-style: preserve-3d; }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 8px; border: 1px solid var(--accent); display: flex; align-items: center; justify-content: center; }
        .card-front { background: var(--card-bg); font-size: 1.5rem; color: var(--accent); }
        .card-back { background: white; transform: rotateY(180deg); padding: 5px; }
        .card-back img { width: 90%; height: 90%; object-fit: contain; }
        .card.matched { cursor: default; opacity: 0.5; pointer-events: none; }
        #status { font-size: 0.8rem; color: #94a3b8; margin-bottom: 5px; font-weight: bold; }
    </style>
</head>
<body id="mainBody">

<header>
    <h2 style="margin:0">üèÜ <span id="roleTitle">Peer</span> View</h2>
    <div id="status">üì° Establishing Connection...</div>
    <div class="controls">
        <div class="row">
            <input type="text" id="playerName" placeholder="Your Name">
            <div class="host-only">
                <select id="diffSelect">
                    <option value="8">Easy (4x4)</option>
                    <option value="12">Medium (6x4)</option>
                    <option value="18">Hard (6x6)</option>
                </select>
            </div>
        </div>
        <div class="row">
            <button id="shareBtn">Copy Invite</button>
            <button id="syncBtn">Force Sync</button>
            <div class="host-only">
                <button id="restartBtn">Start Game</button>
            </div>
        </div>
    </div>
</header>

<main id="gameBoard" class="grid"></main>

<script>
    // 1. Setup multi-relay peers for high reliability
    const gun = Gun({
        peers: [
            'https://gun-manhattan.herokuapp.com/gun',
            'https://peer.wall.org/gun',
            'https://gundb-relay.herokapp.com/gun'
        ]
    });

    const urlParams = new URLSearchParams(window.location.search);
    const isHost = !urlParams.get('session');
    let sessionId = urlParams.get('session') || Math.random().toString(36).substring(7);
    
    if (isHost) {
        window.history.replaceState({}, '', `?session=${sessionId}`);
        document.body.classList.add('is-host');
        document.getElementById('roleTitle').innerText = "Host";
    }

    const room = gun.get('sports-memory-final-' + sessionId);
    const boardEl = document.getElementById('gameBoard');
    let localCards = [];

    // 2. Data Listener (The Heart of Sync)
    room.get('board').on((data) => {
        if (data) {
            localCards = JSON.parse(data);
            updateGridClass(localCards.length);
            render();
            document.getElementById('status').innerText = "‚úÖ ONLINE & SYNCED";
            document.getElementById('status').style.color = "#10b981";
        }
    });

    // 3. Teams List
    const allTeams = [
        {id: "ari", l:"nfl"}, {id: "atl", l:"nfl"}, {id: "bal", l:"nfl"}, {id: "buf", l:"nfl"}, {id: "car", l:"nfl"}, {id: "chi", l:"nfl"}, {id: "cin", l:"nfl"}, {id: "cle", l:"nfl"},
        {id: "lal", l:"nba"}, {id: "bos", l:"nba"}, {id: "chi", l:"nba"}, {id: "gs", l:"nba"}, {id: "mia", l:"nba"}, {id: "ny", l:"nba"}, {id: "phi", l:"nba"}, {id: "phx", l:"nba"},
        {id: "nyy", l:"mlb"}, {id: "lad", l:"mlb"}, {id: "bos", l:"mlb"}, {id: "chc", l:"mlb"}, {id: "sf", l:"mlb"}, {id: "stl", l:"mlb"}, {id: "tex", l:"mlb"}, {id: "tor", l:"mlb"}
    ];

    function generateBoard(count) {
        const shuffled = [...allTeams].sort(() => 0.5 - Math.random()).slice(0, count);
        const board = [...shuffled, ...shuffled]
            .sort(() => 0.5 - Math.random())
            .map((t, i) => ({ ...t, index: i, flipped: false, matched: false }));
        room.get('board').put(JSON.stringify(board));
    }

    function render() {
        boardEl.innerHTML = '';
        localCards.forEach((card, i) => {
            const cardDiv = document.createElement('div');
            cardDiv.className = `card ${card.flipped ? 'flipped' : ''} ${card.matched ? 'matched' : ''}`;
            const logo = `https://a.espncdn.com/i/teamlogos/${card.l}/500/scoreboard/${card.id}.png`;
            cardDiv.innerHTML = `<div class="card-inner"><div class="card-front">?</div><div class="card-back"><img src="${logo}"></div></div>`;
            cardDiv.onclick = () => handleMove(i);
            boardEl.appendChild(cardDiv);
        });
    }

    function handleMove(i) {
        if (localCards[i].flipped || localCards[i].matched) return;
        const active = localCards.filter(c => c.flipped && !c.matched);
        if (active.length >= 2) return;

        localCards[i].flipped = true;
        sync();

        const flipped = localCards.filter(c => c.flipped && !c.matched);
        if (flipped.length === 2) {
            const [c1, c2] = flipped;
            if (c1.id === c2.id && c1.l === c2.l) {
                setTimeout(() => { localCards[c1.index].matched = true; localCards[c2.index].matched = true; sync(); }, 400);
            } else {
                setTimeout(() => { localCards[c1.index].flipped = false; localCards[c2.index].flipped = false; sync(); }, 1200);
            }
        }
    }

    function sync() { room.get('board').put(JSON.stringify(localCards)); }
    function updateGridClass(size) {
        boardEl.className = "grid";
        if (size <= 16) boardEl.classList.add('easy');
        else if (size <= 24) boardEl.classList.add('medium');
        else boardEl.classList.add('hard');
    }

    // UI Buttons
    document.getElementById('shareBtn').onclick = () => {
        navigator.clipboard.writeText(window.location.href);
        alert("Invite Link Copied!");
    };
    document.getElementById('syncBtn').onclick = () => {
        document.getElementById('status').innerText = "üîÑ Re-syncing...";
        room.get('board').once((data) => { if(data) { localCards = JSON.parse(data); render(); } });
    };
    if (isHost) {
        document.getElementById('restartBtn').onclick = () => {
            generateBoard(parseInt(document.getElementById('diffSelect').value));
        };
    }
</script>
</body>
</html>
