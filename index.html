<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Sports Sync Match</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        :root { --bg: #0f172a; --card-bg: #1e293b; --accent: #38bdf8; --text: #f8fafc; --match: #10b981; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; margin: 0; padding: 15px; }
        header { background: var(--card-bg); padding: 20px; border-radius: 12px; width: 100%; max-width: 500px; text-align: center; margin-bottom: 15px; border: 1px solid #334155; }
        .controls { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        input { padding: 12px; border-radius: 8px; border: 1px solid var(--accent); background: #000; color: #fff; text-align: center; font-size: 1rem; }
        .btn-group { display: flex; gap: 10px; justify-content: center; }
        button { flex: 1; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        #restartBtn { background: #ef4444; color: white; }
        #shareBtn { background: var(--match); color: white; }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; max-width: 500px; margin-top: 10px; }
        .card { aspect-ratio: 1/1; perspective: 1000px; cursor: pointer; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 10px; border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; }
        .card-front { background: var(--card-bg); font-size: 1.8rem; color: var(--accent); box-shadow: inset 0 0 15px rgba(56, 189, 248, 0.2); }
        .card-back { background: white; transform: rotateY(180deg); padding: 8px; }
        .card-back img { width: 90%; height: 90%; object-fit: contain; }
        .card.matched { cursor: default; }
        .card.matched .card-back { border-color: var(--match); box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        #status { font-size: 0.85rem; color: #94a3b8; margin-top: 10px; }
    </style>
</head>
<body>

<header>
    <h2 style="margin:0">üèÜ Shared Memory</h2>
    <div id="status">Waiting for board data...</div>
    <div class="controls">
        <input type="text" id="playerName" placeholder="Enter Your Name">
        <div class="btn-group">
            <button id="shareBtn">Copy Link</button>
            <button id="restartBtn">Reset All</button>
        </div>
    </div>
    <div style="margin-top:10px; font-size: 0.8rem; opacity: 0.7;">Room ID: <span id="sessionDisplay"></span></div>
</header>

<main id="gameBoard" class="grid"></main>

<script>
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun', 'https://peer.wall.org/gun']);
    const urlParams = new URLSearchParams(window.location.search);
    let sessionId = urlParams.get('session') || Math.random().toString(36).substring(7);
    if (!urlParams.get('session')) window.history.replaceState({}, '', `?session=${sessionId}`);
    
    document.getElementById('sessionDisplay').innerText = sessionId;
    const room = gun.get('nfl-nba-mlb-sync-' + sessionId);

    // Full Team List (ID matches ESPN CDN)
    const teams = [
        {id: "ari", l:"nfl"}, {id: "atl", l:"nfl"}, {id: "bal", l:"nfl"}, {id: "buf", l:"nfl"},
        {id: "lal", l:"nba"}, {id: "bos", l:"nba"}, {id: "chi", l:"nba"}, {id: "gs", l:"nba"},
        {id: "nyy", l:"mlb"}, {id: "lad", l:"mlb"}, {id: "bos", l:"mlb"}, {id: "chc", l:"mlb"}
    ];

    let localCards = [];

    // 1. Listen for the Board
    room.get('board').on((data) => {
        if (data) {
            localCards = JSON.parse(data);
            render();
            document.getElementById('status').innerText = "‚úÖ Board Synced";
        } else {
            // If no board exists, create one (acts as host)
            generateBoard();
        }
    });

    function generateBoard() {
        document.getElementById('status').innerText = "üõ† Generating Shared Board...";
        // Pick 8 random pairs
        const shuffled = [...teams].sort(() => 0.5 - Math.random()).slice(0, 8);
        const board = [...shuffled, ...shuffled]
            .sort(() => 0.5 - Math.random())
            .map((t, i) => ({ ...t, index: i, flipped: false, matched: false }));
        
        room.get('board').put(JSON.stringify(board));
    }

    function render() {
        const boardEl = document.getElementById('gameBoard');
        boardEl.innerHTML = '';
        localCards.forEach((card, i) => {
            const cardDiv = document.createElement('div');
            cardDiv.className = `card ${card.flipped ? 'flipped' : ''} ${card.matched ? 'matched' : ''}`;
            const logo = `https://a.espncdn.com/i/teamlogos/${card.l}/500/scoreboard/${card.id}.png`;
            
            cardDiv.innerHTML = `
                <div class="card-inner">
                    <div class="card-front">?</div>
                    <div class="card-back"><img src="${logo}"></div>
                </div>`;
            
            cardDiv.onclick = () => handleMove(i);
            boardEl.appendChild(cardDiv);
        });
    }

    function handleMove(i) {
        if (localCards[i].flipped || localCards[i].matched) return;

        const active = localCards.filter(c => c.flipped && !c.matched);
        if (active.length >= 2) return;

        // Flip locally & Sync
        localCards[i].flipped = true;
        updateRemote();

        const currentlyFlipped = localCards.filter(c => c.flipped && !c.matched);
        if (currentlyFlipped.length === 2) {
            const [c1, c2] = currentlyFlipped;
            if (c1.id === c2.id && c1.l === c2.l) {
                // Match!
                setTimeout(() => {
                    localCards[c1.index].matched = true;
                    localCards[c2.index].matched = true;
                    updateRemote();
                }, 500);
            } else {
                // Not a match - let everyone see for 1.5s
                setTimeout(() => {
                    localCards[c1.index].flipped = false;
                    localCards[c2.index].flipped = false;
                    updateRemote();
                }, 1500);
            }
        }
    }

    function updateRemote() {
        room.get('board').put(JSON.stringify(localCards));
    }

    document.getElementById('shareBtn').onclick = () => {
        navigator.clipboard.writeText(window.location.href);
        alert("Invite Link Copied!");
    };

    document.getElementById('restartBtn').onclick = () => {
        if(confirm("This will reset the board for ALL players. Continue?")) generateBoard();
    };

</script>
</body>
</html>