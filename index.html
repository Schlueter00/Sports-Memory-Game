<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sports Memory Game</title>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root {
            --primary-color: #013369;
            --secondary-color: #ffffff;
            --body-bg: #f4f7f9;
            --card-bg: #ffffff;
            --text-color: #2c3e50;
            --app-width: 95%; 
            --max-app-width: 600px;
            --border-ui: #ccc;
            --card-back: #013369;
            --match-color: #2ecc71;
            --accent-red: #e74c3c;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--body-bg); color: var(--text-color); display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        .main-header { margin: 5px 0 10px 0; color: #013369; text-transform: uppercase; font-size: 1.5rem; text-align: center; }

        .app-section { width: var(--app-width); max-width: var(--max-app-width); background: var(--card-bg); border-radius: 8px; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 12px; border-top: 6px solid var(--primary-color); }

        #player-list { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin: 15px 0; 
            justify-content: center; 
        }
        
        .player-entry { 
            background: rgba(0,0,0,0.03); 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid var(--border-ui); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center; 
            min-width: 130px;
            flex-grow: 0;
        }
        .player-entry.active-turn { border: 2px solid #f39c12; background: #fffdf0; }
        .score-pill { background: var(--primary-color); color: white; padding: 2px 8px; border-radius: 10px; font-weight: 900; font-size: 0.7rem; margin-top: 5px; }
        .win-tally { font-size: 0.65rem; color: #e67e22; font-weight: bold; margin-top: 4px; }

        #turn-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(231, 76, 60, 0.95);
            color: white;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            text-transform: uppercase;
            z-index: 10001;
            display: none;
            pointer-events: none;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            border: 2px solid white;
        }

        .memory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; width: 100%; background: var(--border-ui); padding: 6px; border-radius: 4px; }
        .memory-card { aspect-ratio: 1 / 1.1; position: relative; cursor: pointer; transform-style: preserve-3d; transition: transform 0.4s; }
        .memory-card.flipped { transform: rotateY(180deg); }
        
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 4px; padding: 4px; }
        .card-front { background: var(--card-back); }
        .card-front::after { content: "?"; color: white; font-weight: 900; font-size: 1.5rem; }

        .card-back { background: white; transform: rotateY(180deg); }
        .memory-card.matched .card-back { background-color: var(--match-color); border: 2px solid white; }
        
        .card-back .player-label { font-size: 0.45rem; font-weight: bold; color: #fff; background: rgba(0,0,0,0.3); padding: 1px 4px; border-radius: 3px; margin-bottom: 2px; visibility: hidden; white-space: nowrap; overflow: hidden; max-width: 90%; }
        .memory-card.matched .player-label { visibility: visible; }
        .card-back img { width: 65%; height: 50%; object-fit: contain; }
        .card-back .team-label { font-size: 0.5rem; font-weight: 900; text-align: center; line-height: 1.1; margin-top: 2px; text-transform: uppercase; word-break: break-word; }

        #win-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 350px; background: var(--primary-color); color: var(--secondary-color); padding: 20px; border-radius: 15px; text-align: center; z-index: 10000; border: 4px solid var(--secondary-color); }

        .controls-stack { display: flex; flex-direction: column; align-items: center; gap: 8px; margin-top: 15px; width: 100%; }
        .controls-row { display: flex; gap: 8px; width: 100%; max-width: 400px; justify-content: center; }
        .controls-row button { flex: 1; }
        .btn-full { width: 100%; max-width: 400px; }

        select, input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-ui); font-size: 0.8rem; }
        button { padding: 10px; cursor: pointer; font-weight: bold; border-radius: 8px; border: none; text-transform: uppercase; color: white; font-size: 0.7rem; }
        .btn-blue { background: #3498db; }
        .btn-green { background: #27ae60; }
        .btn-orange { background: #f39c12; }
        .btn-red { background: var(--accent-red); }
        .btn-next { background: var(--secondary-color); color: var(--primary-color); width: 100%; margin-top: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <h1 class="main-header">Sports Memory Game</h1>

    <div id="turn-popup"></div>

    <div id="win-modal">
        <h1 id="win-title" style="font-size: 1.8rem; margin: 0;">GAME OVER!</h1>
        <p id="winner-text" style="font-size: 1rem; margin: 10px 0;"></p>
        <button id="host-reset-btn" class="btn-next" style="display:none;" onclick="hostReset()">Next Round</button>
        <button onclick="document.getElementById('win-modal').style.display='none'" style="margin-top:10px; background:transparent; border:1px solid white; color:white; font-size:0.6rem;">Close</button>
    </div>

    <section class="app-section">
        <label style="font-size:0.6rem; font-weight:bold;">YOUR NAME:</label>
        <input type="text" id="playerName" value="Player" onchange="updateMyName()" placeholder="Your Name">
        
        <div id="join-ui" style="display:none; margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
            <label style="font-size:0.6rem; font-weight:bold;">JOIN A GAME:</label>
            <div style="display: flex; gap: 5px; margin-top: 5px;">
                <input type="text" id="join-id-input" placeholder="Enter Game ID">
                <button class="btn-green" onclick="manualJoin()">Join ‚ûî</button>
            </div>
        </div>

        <div id="host-ui" style="display:none; margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
            <div style="margin-bottom:10px;">
                <label style="font-size:0.6rem; font-weight:bold;">CUSTOM GAME ID (Host):</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="custom-game-id" placeholder="e.g. MyGame123">
                    <button class="btn-orange" onclick="setCustomGameID()">Set ID</button>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                <div>
                    <label style="font-size:0.6rem; font-weight:bold;">LEAGUE:</label>
                    <select id="league-select" onchange="hostReset()">
                        <option value="all">All Sports</option>
                        <option value="nfl">NFL</option>
                        <option value="nba">NBA</option>
                        <option value="mlb">MLB</option>
                        <option value="nhl">NHL</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:0.6rem; font-weight:bold;">SIZE:</label>
                    <select id="size-select" onchange="hostReset()">
                        <option value="16">16 Cards</option>
                        <option value="24">24 Cards</option>
                        <option value="32">32 Cards</option>
                    </select>
                </div>
            </div>
            
            <div class="controls-stack">
                <button class="btn-blue btn-full" onclick="copyInvite()">Copy Invite Link üîó</button>
                <div class="controls-row">
                    <button class="btn-green" onclick="hostReset()">Generate Card üîÑ</button>
                    <button class="btn-red" onclick="resetLeaderboard()">Reset üèÜ</button>
                </div>
            </div>
        </div>

        <div id="player-list"></div>
    </section>

    <div class="app-section">
        <div id="game-board" class="memory-grid"></div>
    </div>

    <script>
        const nflTeams = [
            { n: "Cardinals", i: "https://upload.wikimedia.org/wikipedia/en/7/72/Arizona_Cardinals_logo.svg" }, { n: "Falcons", i: "https://upload.wikimedia.org/wikipedia/en/c/c5/Atlanta_Falcons_logo.svg" },
            { n: "Ravens", i: "https://upload.wikimedia.org/wikipedia/en/1/16/Baltimore_Ravens_logo.svg" }, { n: "Bills", i: "https://upload.wikimedia.org/wikipedia/en/7/77/Buffalo_Bills_logo.svg" },
            { n: "Panthers", i: "https://upload.wikimedia.org/wikipedia/en/1/1c/Carolina_Panthers_logo.svg" }, { n: "Bears", i: "https://upload.wikimedia.org/wikipedia/commons/5/5c/Chicago_Bears_logo.svg" },
            { n: "Bengals", i: "https://upload.wikimedia.org/wikipedia/commons/8/81/Cincinnati_Bengals_logo.svg" }, { n: "Browns", i: "https://upload.wikimedia.org/wikipedia/en/d/d9/Cleveland_Browns_logo.svg" },
            { n: "Cowboys", i: "https://upload.wikimedia.org/wikipedia/commons/1/15/Dallas_Cowboys.svg" }, { n: "Broncos", i: "https://upload.wikimedia.org/wikipedia/en/4/44/Denver_Broncos_logo.svg" },
            { n: "Lions", i: "https://upload.wikimedia.org/wikipedia/en/7/71/Detroit_Lions_logo.svg" }, { n: "Packers", i: "https://upload.wikimedia.org/wikipedia/commons/5/50/Green_Bay_Packers_logo.svg" },
            { n: "Texans", i: "https://upload.wikimedia.org/wikipedia/en/2/28/Houston_Texans_logo.svg" }, { n: "Colts", i: "https://upload.wikimedia.org/wikipedia/commons/0/00/Indianapolis_Colts_logo.svg" },
            { n: "Jaguars", i: "https://upload.wikimedia.org/wikipedia/en/7/74/Jacksonville_Jaguars_logo.svg" }, { n: "Chiefs", i: "https://upload.wikimedia.org/wikipedia/en/e/e1/Kansas_City_Chiefs_logo.svg" },
            { n: "Raiders", i: "https://upload.wikimedia.org/wikipedia/en/4/48/Las_Vegas_Raiders_logo.svg" }, { n: "Chargers", i: "https://upload.wikimedia.org/wikipedia/en/7/72/NFL_Chargers_logo.svg" },
            { n: "Rams", i: "https://upload.wikimedia.org/wikipedia/en/8/8a/Los_Angeles_Rams_logo.svg" }, { n: "Dolphins", i: "https://upload.wikimedia.org/wikipedia/en/3/37/Miami_Dolphins_logo.svg" },
            { n: "Vikings", i: "https://upload.wikimedia.org/wikipedia/en/4/48/Minnesota_Vikings_logo.svg" }, { n: "Patriots", i: "https://upload.wikimedia.org/wikipedia/en/b/b9/New_England_Patriots_logo.svg" },
            { n: "Saints", i: "https://upload.wikimedia.org/wikipedia/commons/5/50/New_Orleans_Saints_logo.svg" }, { n: "Giants", i: "https://upload.wikimedia.org/wikipedia/commons/6/60/New_York_Giants_logo.svg" },
            { n: "Jets", i: "https://upload.wikimedia.org/wikipedia/en/6/6b/New_York_Jets_logo.svg" }, { n: "Eagles", i: "https://upload.wikimedia.org/wikipedia/en/8/8e/Philadelphia_Eagles_logo.svg" },
            { n: "Steelers", i: "https://upload.wikimedia.org/wikipedia/commons/d/de/Pittsburgh_Steelers_logo.svg" }, { n: "49ers", i: "https://upload.wikimedia.org/wikipedia/commons/3/3a/San_Francisco_49ers_logo.svg" },
            { n: "Seahawks", i: "https://upload.wikimedia.org/wikipedia/en/8/8e/Seattle_Seahawks_logo.svg" }, { n: "Buccaneers", i: "https://upload.wikimedia.org/wikipedia/en/a/a2/Tampa_Bay_Buccaneers_logo.svg" },
            { n: "Titans", i: "https://upload.wikimedia.org/wikipedia/en/c/c1/Tennessee_Titans_logo.svg" }, { n: "Commanders", i: "https://upload.wikimedia.org/wikipedia/commons/0/0c/Washington_Commanders_logo.svg" }
        ];

        const nbaTeams = [
            { n: "Hawks", i: "https://upload.wikimedia.org/wikipedia/en/2/24/Atlanta_Hawks_logo.svg" }, { n: "Celtics", i: "https://upload.wikimedia.org/wikipedia/en/8/8f/Boston_Celtics.svg" },
			{ n: "Nets", i: "https://upload.wikimedia.org/wikipedia/en/4/40/Brooklyn_Nets_primary_icon_logo_2024.svg" },	{ n: "Hornets", i: "https://upload.wikimedia.org/wikipedia/en/c/c4/Charlotte_Hornets_%282014%29.svg" },
			{ n: "Bulls", i: "https://upload.wikimedia.org/wikipedia/en/6/67/Chicago_Bulls_logo.svg" },	{ n: "Cavaliers", i: "https://upload.wikimedia.org/wikipedia/commons/4/4b/Cleveland_Cavaliers_logo.svg" },
			{ n: "Mavericks", i: "https://upload.wikimedia.org/wikipedia/en/9/97/Dallas_Mavericks_logo.svg" }, { n: "Nuggets", i: "https://upload.wikimedia.org/wikipedia/en/7/76/Denver_Nuggets.svg" },
			{ n: "Pistons", i: "https://upload.wikimedia.org/wikipedia/commons/c/c9/Logo_of_the_Detroit_Pistons.svg" }, { n: "Warriors", i: "https://upload.wikimedia.org/wikipedia/en/0/01/Golden_State_Warriors_logo.svg" },
			{ n: "Rockets", i: "https://upload.wikimedia.org/wikipedia/en/2/28/Houston_Rockets.svg" }, { n: "Pacers", i: "https://upload.wikimedia.org/wikipedia/en/1/1b/Indiana_Pacers.svg" },
			{ n: "Clippers", i: "https://upload.wikimedia.org/wikipedia/en/e/ed/Los_Angeles_Clippers_%282024%29.svg" }, { n: "Lakers", i: "https://upload.wikimedia.org/wikipedia/commons/3/3c/Los_Angeles_Lakers_logo.svg" },
			{ n: "Grizzlies", i: "https://upload.wikimedia.org/wikipedia/en/f/f1/Memphis_Grizzlies.svg" }, { n: "Heat", i: "https://upload.wikimedia.org/wikipedia/en/f/fb/Miami_Heat_logo.svg" },
			{ n: "Bucks", i: "https://upload.wikimedia.org/wikipedia/en/4/4a/Milwaukee_Bucks_logo.svg" }, { n: "Timberwolves", i: "https://upload.wikimedia.org/wikipedia/en/c/c2/Minnesota_Timberwolves_logo.svg" },
			{ n: "Pelicans", i: "https://upload.wikimedia.org/wikipedia/en/0/0d/New_Orleans_Pelicans_logo.svg" }, { n: "Knicks", i: "https://upload.wikimedia.org/wikipedia/en/2/25/New_York_Knicks_logo.svg" },
			{ n: "Thunder", i: "https://upload.wikimedia.org/wikipedia/en/5/5d/Oklahoma_City_Thunder.svg" }, { n: "Magic", i: "https://upload.wikimedia.org/wikipedia/en/1/10/Orlando_Magic_logo.svg" },
			{ n: "76ers", i: "https://upload.wikimedia.org/wikipedia/en/0/0e/Philadelphia_76ers_logo.svg" }, { n: "Suns", i: "https://upload.wikimedia.org/wikipedia/en/d/dc/Phoenix_Suns_logo.svg" },
			{ n: "Blazers", i: "https://upload.wikimedia.org/wikipedia/en/2/21/Portland_Trail_Blazers_logo.svg" }, { n: "Kings", i: "https://upload.wikimedia.org/wikipedia/en/c/c7/SacramentoKings.svg" },
			{ n: "Spurs", i: "https://upload.wikimedia.org/wikipedia/en/a/a2/San_Antonio_Spurs.svg" }, { n: "Raptors", i: "https://upload.wikimedia.org/wikipedia/en/3/36/Toronto_Raptors_logo.svg" },
			{ n: "Jazz", i: "https://upload.wikimedia.org/wikipedia/en/7/77/Utah_Jazz_logo_2025.svg" }, { n: "Wizards", i: "https://upload.wikimedia.org/wikipedia/en/0/02/Washington_Wizards_logo.svg" }
        ];

        const mlbTeams = [
            { n: "Diamondbacks", i: "https://upload.wikimedia.org/wikipedia/commons/a/ac/Arizona_Diamondbacks_logo_teal.svg" }, { n: "Braves", i: "https://upload.wikimedia.org/wikipedia/en/f/f2/Atlanta_Braves.svg" },
			{ n: "Orioles", i: "https://upload.wikimedia.org/wikipedia/commons/e/e9/Baltimore_Orioles_Script.svg" }, { n: "Red Sox", i: "https://upload.wikimedia.org/wikipedia/en/6/6d/RedSoxPrimary_HangingSocks.svg" },
			{ n: "Cubs", i: "https://upload.wikimedia.org/wikipedia/commons/8/80/Chicago_Cubs_logo.svg" }, { n: "White Sox", i: "https://upload.wikimedia.org/wikipedia/commons/c/c1/Chicago_White_Sox.svg" },
			{ n: "Reds", i: "https://upload.wikimedia.org/wikipedia/commons/0/01/Cincinnati_Reds_Logo.svg" }, { n: "Guardians", i: "https://upload.wikimedia.org/wikipedia/en/a/a9/Guardians_winged_%22G%22.svg" },
			{ n: "Rockies", i: "https://upload.wikimedia.org/wikipedia/commons/3/31/Colorado_Rockies_logo.svg" }, { n: "Tigers", i: "https://upload.wikimedia.org/wikipedia/commons/e/e3/Detroit_Tigers_logo.svg" },
			{ n: "Astros", i: "https://upload.wikimedia.org/wikipedia/commons/6/6b/Houston-Astros-Logo.svg" }, { n: "Royals", i: "https://upload.wikimedia.org/wikipedia/commons/7/78/Kansas_City_Royals_Primary_Logo.svg" },
			{ n: "Angels", i: "https://upload.wikimedia.org/wikipedia/commons/8/8b/Los_Angeles_Angels_of_Anaheim.svg" }, { n: "Dodgers", i: "https://upload.wikimedia.org/wikipedia/commons/0/0e/Los_Angeles_Dodgers_Logo.svg" },
			{ n: "Marlins", i: "https://upload.wikimedia.org/wikipedia/en/f/fd/Marlins_team_logo.svg" }, { n: "Brewers", i: "https://upload.wikimedia.org/wikipedia/en/b/b8/Milwaukee_Brewers_logo.svg" },
			{ n: "Twins", i: "https://upload.wikimedia.org/wikipedia/commons/1/17/Minnesota_Twins_New_Logo.svg" }, { n: "Mets", i: "https://upload.wikimedia.org/wikipedia/en/7/7b/New_York_Mets.svg" },
			{ n: "Yankees", i: "https://upload.wikimedia.org/wikipedia/commons/f/fe/New_York_Yankees_Primary_Logo.svg" }, { n: "Athletics", i: "https://upload.wikimedia.org/wikipedia/commons/a/a4/Oakland_A%27s_logo.svg" },
			{ n: "Phillies", i: "https://upload.wikimedia.org/wikipedia/en/f/f0/Philadelphia_Phillies_%282019%29_logo.svg" }, { n: "Pirates", i: "https://upload.wikimedia.org/wikipedia/commons/8/81/Pittsburgh_Pirates_logo_2014.svg" },
			{ n: "Padres", i: "https://upload.wikimedia.org/wikipedia/commons/e/e2/SD_Logo_Brown.svg" }, { n: "Giants", i: "https://upload.wikimedia.org/wikipedia/en/5/58/San_Francisco_Giants_Logo.svg" },
			{ n: "Mariners", i: "https://upload.wikimedia.org/wikipedia/en/6/6d/Seattle_Mariners_logo_%28low_res%29.svg" }, { n: "Cardinals", i: "https://upload.wikimedia.org/wikipedia/en/9/9d/St._Louis_Cardinals_logo.svg" },
			{ n: "Rays", i: "https://upload.wikimedia.org/wikipedia/commons/5/55/Tampa_Bay_Rays_Logo.svg" }, { n: "Rangers", i: "https://upload.wikimedia.org/wikipedia/commons/c/c7/Texas_Rangers_logo.svg" },
			{ n: "Blue Jays", i: "https://upload.wikimedia.org/wikipedia/en/c/cc/Toronto_Blue_Jay_Primary_Logo.svg" }, { n: "Nationals", i: "https://upload.wikimedia.org/wikipedia/commons/a/a3/Washington_Nationals_logo.svg" }
        ];

        const nhlTeams = [
            { n: "Ducks", i: "https://upload.wikimedia.org/wikipedia/en/7/72/Anaheim_Ducks_logo.svg" }, { n: "Bruins", i: "https://upload.wikimedia.org/wikipedia/en/1/12/Boston_Bruins.svg" },
            { n: "Sabres", i: "https://upload.wikimedia.org/wikipedia/en/9/9e/Buffalo_Sabres_Logo.svg" }, { n: "Flames", i: "https://upload.wikimedia.org/wikipedia/en/6/61/Calgary_Flames_logo.svg" },
            { n: "Hurricanes", i: "https://upload.wikimedia.org/wikipedia/en/3/32/Carolina_Hurricanes_logo.svg" }, { n: "Blackhawks", i: "https://upload.wikimedia.org/wikipedia/en/2/29/Chicago_Blackhawks_logo.svg" },
            { n: "Avalanche", i: "https://upload.wikimedia.org/wikipedia/en/4/45/Colorado_Avalanche_logo.svg" }, { n: "Blue Jackets", i: "https://upload.wikimedia.org/wikipedia/en/5/5d/Columbus_Blue_Jackets_logo.svg" },
            { n: "Stars", i: "https://upload.wikimedia.org/wikipedia/en/2/2a/Dallas_Stars_logo.svg" }, { n: "Red Wings", i: "https://upload.wikimedia.org/wikipedia/en/e/e0/Detroit_Red_Wings_logo.svg" },
            { n: "Oilers", i: "https://upload.wikimedia.org/wikipedia/en/4/4d/Edmonton_Oilers_logo.svg" }, { n: "Panthers", i: "https://upload.wikimedia.org/wikipedia/en/4/43/Florida_Panthers_2016_logo.svg" },
            { n: "Kings", i: "https://upload.wikimedia.org/wikipedia/en/c/ca/Los_Angeles_Kings_2024_logo.svg" }, { n: "Wild", i: "https://upload.wikimedia.org/wikipedia/en/1/1b/Minnesota_Wild_logo.svg" },
            { n: "Canadiens", i: "https://upload.wikimedia.org/wikipedia/commons/6/69/Montreal_Canadiens.svg" }, { n: "Predators", i: "https://upload.wikimedia.org/wikipedia/en/9/9c/Nashville_Predators_Logo_2011.svg" },
            { n: "Devils", i: "https://upload.wikimedia.org/wikipedia/en/9/9f/New_Jersey_Devils_logo.svg" }, { n: "Islanders", i: "https://upload.wikimedia.org/wikipedia/en/4/42/New_York_Islanders_logo.svg" },
            { n: "Rangers", i: "https://upload.wikimedia.org/wikipedia/commons/a/ae/New_York_Rangers.svg" }, { n: "Senators", i: "https://upload.wikimedia.org/wikipedia/en/d/db/Ottawa_Senators.svg" },
            { n: "Flyers", i: "https://upload.wikimedia.org/wikipedia/en/d/dc/Philadelphia_Flyers.svg" }, { n: "Penguins", i: "https://upload.wikimedia.org/wikipedia/en/c/c0/Pittsburgh_Penguins_logo.svg" },
            { n: "Sharks", i: "https://upload.wikimedia.org/wikipedia/en/3/37/San_Jose_Sharks_logo.svg" }, { n: "Kraken", i: "https://upload.wikimedia.org/wikipedia/en/4/48/Seattle_Kraken_official_logo.svg" },
            { n: "Blues", i: "https://upload.wikimedia.org/wikipedia/en/e/ed/St._Louis_Blues_logo.svg" }, { n: "Lightning", i: "https://upload.wikimedia.org/wikipedia/en/2/2f/Tampa_Bay_Lightning_Logo_2011.svg" },
            { n: "Maple Leafs", i: "https://upload.wikimedia.org/wikipedia/en/b/b6/Toronto_Maple_Leafs_2016_logo.svg" }, { n: "Utah", i: "https://upload.wikimedia.org/wikipedia/en/a/ad/Utah_Hockey_Club_logo.svg" },
            { n: "Canucks", i: "https://upload.wikimedia.org/wikipedia/en/3/3a/Vancouver_Canucks_logo.svg" }, { n: "Golden Knights", i: "https://upload.wikimedia.org/wikipedia/en/a/ac/Vegas_Golden_Knights_logo.svg" },
            { n: "Capitals", i: "https://upload.wikimedia.org/wikipedia/en/2/2d/Washington_Capitals.svg" }, { n: "Jets", i: "https://upload.wikimedia.org/wikipedia/en/9/93/Winnipeg_Jets_Logo_2011.svg" }
        ];

        let peer, connections = {}, isHost = false, gameID = null, lastTurnId = null;
        let gameState = { cards: [], players: {}, playerOrder: [], turnIndex: 0, flippedIndices: [], isProcessing: false };

        window.onload = () => { 
            const urlParams = new URLSearchParams(window.location.search); 
            const joinId = urlParams.get('game');
            if (joinId) { initPeer(joinId); } else { initPeer(); }
        };

        function initPeer(id = null) {
            if (peer) peer.destroy();
            peer = new Peer();

            peer.on('open', (assignedId) => {
                if (id) {
                    gameID = id; isHost = false;
                    document.getElementById('host-ui').style.display = 'none';
                    document.getElementById('join-ui').style.display = 'none';
                    connectToHost(id);
                } else {
                    gameID = assignedId; isHost = true;
                    document.getElementById('host-ui').style.display = 'block';
                    document.getElementById('join-ui').style.display = 'block';
                    document.getElementById('custom-game-id').value = assignedId;
                    if (!gameState.players[peer.id]) {
                        gameState.players[peer.id] = { name: document.getElementById('playerName').value, score: 0, totalWins: 0 };
                        gameState.playerOrder = [peer.id];
                    }
                    setupNewGame();
                }
            });
            peer.on('error', (err) => {
                if(err.type === 'peer-unavailable') alert("Game not found.");
                else if(err.type === 'unavailable-id') alert("ID taken.");
                console.error(err);
            });
            peer.on('connection', setupConn);
        }

        function manualJoin() {
            const idToJoin = document.getElementById('join-id-input').value.trim();
            if(!idToJoin) return alert("Enter Game ID");
            initPeer(idToJoin);
        }

        function setCustomGameID() {
            const newID = document.getElementById('custom-game-id').value.trim();
            if (!newID || !isHost) return;
            if (confirm("Changing ID will reset the game. Continue?")) {
                if (peer) peer.destroy();
                peer = new Peer(newID);
                peer.on('open', (assignedId) => {
                    gameID = assignedId; connections = {};
                    gameState.players = { [peer.id]: { name: document.getElementById('playerName').value, score: 0, totalWins: 0 } };
                    gameState.playerOrder = [peer.id];
                    setupNewGame();
                });
                peer.on('error', (err) => { if(err.type === 'unavailable-id') { alert("ID taken."); initPeer(); } });
                peer.on('connection', setupConn);
            }
        }

        function setupConn(conn) {
            conn.on('open', () => {
                connections[conn.peer] = conn;
                if (isHost) {
                    document.getElementById('join-ui').style.display = 'none';
                    if (!gameState.players[conn.peer]) {
                        gameState.players[conn.peer] = { name: "Player", score: 0, totalWins: 0 };
                        gameState.playerOrder.push(conn.peer);
                    }
                    broadcastState();
                } else {
                    conn.send({ type: 'name_update', name: document.getElementById('playerName').value });
                }
            });

            conn.on('data', (data) => {
                if (data.type === 'state_update') {
                    const oldTurnId = lastTurnId;
                    gameState = data.state;
                    document.getElementById('join-ui').style.display = 'none'; 
                    renderBoard(); updatePlayerList();
                    
                    const newTurnId = gameState.playerOrder[gameState.turnIndex];
                    if (newTurnId !== oldTurnId || data.forceTurnPopup) {
                        showTurnPopup(gameState.players[newTurnId].name);
                        lastTurnId = newTurnId;
                    }

                    if (data.showWin) triggerWinPopup(data.winnerName, data.isDraw);
                    if (data.hideWin) document.getElementById('win-modal').style.display = 'none';
                }
                if (isHost) {
                    if (data.type === 'flip') handleFlip(data.index, conn.peer);
                    if (data.type === 'name_update') { 
                        if (gameState.players[conn.peer]) {
                            gameState.players[conn.peer].name = data.name; 
                            broadcastState(); 
                        }
                    }
                }
            });
        }

        function connectToHost(id) { const conn = peer.connect(id); setupConn(conn); }

        function setupNewGame() {
            const league = document.getElementById('league-select').value;
            const count = parseInt(document.getElementById('size-select').value);
            
            let pool;
            if (league === 'nfl') pool = nflTeams;
            else if (league === 'nba') pool = nbaTeams;
            else if (league === 'mlb') pool = mlbTeams;
            else if (league === 'nhl') pool = nhlTeams;
            else pool = [...nflTeams, ...nbaTeams, ...mlbTeams, ...nhlTeams];

            let picked = shuffle([...pool]).slice(0, count / 2);
            let gameIcons = shuffle([...picked, ...picked]);
            gameState.cards = gameIcons.map(t => ({ id: t.n + t.i, n: t.n, i: t.i, flipped: false, matched: false, matchedBy: '' }));
            gameState.flippedIndices = [];
            gameState.isProcessing = false;
            Object.keys(gameState.players).forEach(id => gameState.players[id].score = 0);
            
            const starterId = gameState.playerOrder[gameState.turnIndex];
            showTurnPopup(gameState.players[starterId].name);
            
            broadcastState({ hideWin: true, forceTurnPopup: true });
        }

        function showTurnPopup(name) {
            const popup = document.getElementById('turn-popup');
            popup.innerText = `${name}'s Turn`;
            popup.style.display = 'block';
            setTimeout(() => { popup.style.display = 'none'; }, 2000);
        }

        function handleFlip(index, peerId) {
            if (gameState.isProcessing || gameState.playerOrder[gameState.turnIndex] !== peerId) return;
            if (gameState.cards[index].flipped || gameState.cards[index].matched) return;
            gameState.cards[index].flipped = true;
            gameState.flippedIndices.push(index);
            broadcastState();

            if (gameState.flippedIndices.length === 2) {
                gameState.isProcessing = true;
                const [idx1, idx2] = gameState.flippedIndices;
                if (gameState.cards[idx1].id === gameState.cards[idx2].id) {
                    setTimeout(() => {
                        const matcher = gameState.players[peerId];
                        gameState.cards[idx1].matched = true;
                        gameState.cards[idx1].matchedBy = matcher.name;
                        gameState.cards[idx2].matched = true;
                        gameState.cards[idx2].matchedBy = matcher.name;
                        matcher.score += 1;
                        gameState.flippedIndices = [];
                        gameState.isProcessing = false;
                        if (gameState.cards.every(c => c.matched)) {
                            const sorted = Object.values(gameState.players).sort((a,b) => b.score - a.score);
                            const isDraw = sorted.length > 1 && sorted[0].score === sorted[1].score;
                            if (!isDraw) {
                                const winnerId = Object.keys(gameState.players).find(k => gameState.players[k].name === sorted[0].name);
                                gameState.players[winnerId].totalWins += 1;
                            }
                            broadcastState({ showWin: true, winnerName: sorted[0].name, isDraw: isDraw });
                        } else { broadcastState(); }
                    }, 600);
                } else {
                    setTimeout(() => {
                        gameState.cards[idx1].flipped = false;
                        gameState.cards[idx2].flipped = false;
                        gameState.flippedIndices = [];
                        gameState.turnIndex = (gameState.turnIndex + 1) % gameState.playerOrder.length;
                        gameState.isProcessing = false;
                        broadcastState();
                    }, 1200);
                }
            }
        }

        function broadcastState(extra = {}) {
            const payload = { type: 'state_update', state: gameState, ...extra };
            Object.values(connections).forEach(c => { if (c.open) c.send(payload); });
            renderBoard(); updatePlayerList();
            
            const currentTurnId = gameState.playerOrder[gameState.turnIndex];
            if (currentTurnId !== lastTurnId && !extra.forceTurnPopup) {
                showTurnPopup(gameState.players[currentTurnId].name);
                lastTurnId = currentTurnId;
            }

            if (extra.showWin) triggerWinPopup(extra.winnerName, extra.isDraw);
            if (extra.hideWin) document.getElementById('win-modal').style.display = 'none';
        }

        function renderBoard() {
            const board = document.getElementById('game-board');
            board.innerHTML = '';
            gameState.cards.forEach((card, index) => {
                const div = document.createElement('div');
                div.className = `memory-card ${card.flipped || card.matched ? 'flipped' : ''} ${card.matched ? 'matched' : ''}`;
                div.innerHTML = `<div class="card-face card-front"></div><div class="card-face card-back"><div class="player-label">${card.matchedBy}</div><img src="${card.i}"><div class="team-label">${card.n}</div></div>`;
                div.onclick = () => {
                    if (isHost) handleFlip(index, peer.id);
                    else { const hostConn = Object.values(connections)[0]; if (hostConn && hostConn.open) hostConn.send({ type: 'flip', index: index }); }
                };
                board.appendChild(div);
            });
        }

        function updatePlayerList() {
            const list = document.getElementById('player-list');
            const activeId = gameState.playerOrder[gameState.turnIndex];
            list.innerHTML = gameState.playerOrder.map(id => {
                const p = gameState.players[id];
                return `<div class="player-entry ${id === activeId ? 'active-turn' : ''}">
                    <strong style="font-size:0.75rem;">${p ? p.name : 'Joining...'}</strong>
                    <span class="score-pill">${p ? p.score : 0} Pairs</span>
                    <span class="win-tally">Season Wins: ${p ? (p.totalWins || 0) : 0}</span>
                </div>`;
            }).join('');
        }

        function triggerWinPopup(name, isDraw) {
            const title = document.getElementById('win-title');
            const text = document.getElementById('winner-text');
            if (isDraw) { title.innerText = "IT'S A DRAW!"; text.innerText = "No Season Win awarded."; } 
            else { title.innerText = "WINNER!"; text.innerText = `${name.toUpperCase()} earns a Season Win!`; confetti({ particleCount: 150, spread: 60 }); }
            document.getElementById('win-modal').style.display = 'block';
            document.getElementById('host-reset-btn').style.display = isHost ? 'inline-block' : 'none';
        }

        function resetLeaderboard() { if(isHost && confirm("Clear all Season Wins?")) { Object.keys(gameState.players).forEach(id => gameState.players[id].totalWins = 0); broadcastState(); } }
        function hostReset() { if(isHost) setupNewGame(); }
        function updateMyName() {
            const name = document.getElementById('playerName').value;
            if (isHost) { gameState.players[peer.id].name = name; broadcastState(); }
            else { const hostConn = Object.values(connections)[0]; if (hostConn && hostConn.open) hostConn.send({ type: 'name_update', name }); }
        }
        function copyInvite() { 
            const url = `${window.location.origin}${window.location.pathname}?game=${gameID}`; 
            navigator.clipboard.writeText(url).then(() => alert("Link Copied!")); 
        }
        function shuffle(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }
    </script>
</body>
</html>
